const { ethers } = require('ethers');

// ConfiguraÃ§Ãµes
const PRIVATE_KEY = "0xe6802d288e10e94a9e7910793b6a58328f4011ab622d19ad2636ce28264812e5";
const RPC_URL = "https://1rpc.io/sepolia";
const OWNER_ADDRESS = "0x133fD7F7094DBd17b576907d052a5aCBd48dB526";
const WARP_ROUTE = "0x224a4419D7FA69D3bEbAbce574c7c84B48D829b4";
const ORACLE_ADDRESS = "0x7113Df4d1D8B230e6339011d10277a6E5AC4eC9c";

const TERRA_DOMAIN = 1325;
const TERRA_EXCHANGE_RATE = "28444000000000000";
const TERRA_GAS_PRICE = "38325000000";
const GAS_OVERHEAD = "200000";

// Bytecode e ABI do SimpleIGP
const IGP_BYTECODE = "0x608060405234801561000f575f80fd5b5060405161098238038061098283398101604081905261002e91610050565b5f80546001600160a01b039384166001600160a01b0319918216179091556001805492909316911617905561007f565b5f8060408385031215610061575f80fd5b82516001600160a01b0381168114610077575f80fd5b6020939093015192949293505050565b6108f68061008d5f395ff3fe608060405260043610610084575f3560e01c8063a18a186611610057578063a18a18661461016f578063b08e56d014610182578063c2d8bcdb146101b1578063d5bed615146101d1578063e8d0f0dc146101f0575f80fd5b80632e40e6e31461008857806338af3eed146100c857806360fcef7c146100fc5780638da5cb5b1461012d575b5f80fd5b348015610093575f80fd5b506100b56100a2366004610725565b60026020525f908152604090205481565b6040519081526020015b60405180910390f35b3480156100d3575f80fd5b506001546100e7906001600160a01b031681565b60405161013f9291906107d7565b60405180910390f35b348015610107575f80fd5b506100b5610116366004610802565b6bffffffffffffffffffffffff169052565b348015610138575f80fd5b505f546100e7906001600160a01b031681565b34801561015a575f80fd5b50610163610226565b60405161013f9190610836565b61016361017d366004610872565b610227565b34801561018d575f80fd5b506101a161019c366004610725565b610228565b60405161013f94939291906108dc565b3480156101bc575f80fd5b506101c56102a1565b60405161013f9190610913565b3480156101dc575f80fd5b506100b56101eb366004610725565b6102ab565b3480156101fb575f80fd5b5061020f61020a366004610725565b610370565b60405161013f92919061091f565b5050565b6004545f906001600160a01b0316610241576040517f4e6f206f7261636c650000000000000000000000000000000000000000000000815260040160405180910390fd5b60045f9054906101000a90046001600160a01b03166001600160a01b03166360fcef7c866040518263ffffffff1660e01b8152600401610283919061094f565b604080518083038186803b158015610299575f80fd5b505afa1580156102ac573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906102d0919061096e565b90925090506102e860016bffffffffffffffffffffffff8316846109d9565b6bffffffffffffffffffffffff168161031d576bffffffffffffffffffffffff821661031f565b5f5b6bffffffffffffffffffffffff168261033a576bffffffffffffffffffffffff83166103825760010b84020282525050505050565b5050505050565b6003602052815f5260405f20815f91509150505481565b6001546001600160a01b03166108fc4790811502906040515f60405180830381858888f1935050505015801561038c573d5f803e3d5ffd5b50565b5f54600160a01b900460ff16156103c0576040517f53796e746178206572726f720000000000000000000000000000000000000000815260040160405180910390fd5b6001546001600160a01b031681565b5f80fd5b63ffffffff811681146103e2575f80fd5b50565b5f602082840312156103f5575f80fd5b813561040081610395565b9392505050565b6001600160a01b0381168114610417575f80fd5b50565b5f6020828403121561042a575f80fd5b813561040081610407565b6bffffffffffffffffffffffff81168114610444575f80fd5b50565b5f805f60608486031215610459575f80fd5b833561046481610395565b9250602084013561047481610407565b9150604084013561048481610435565b809150509250925092565b5f8060408385031215610499575f80fd5b82356104a481610395565b946020939093013593505050565b5f5b838110156104cc5781810151838201526020016104b4565b50505f910152565b5f81518084526104eb8160208601602086016104b2565b601f01601f19169290920160200192915050565b60208152816020820152818360408301375f818301604090810191909152601f909201601f19160101919050565b5f805f60608486031215610540575f80fd5b833561054b81610395565b95602085013595506040909401359392505050565b6bffffffffffffffffffffffff81511682526020810151602083015260408101516040830152606081015160608301525050565b5f60608201905063ffffffff8084511683528060208501511660208401528060408501511660408401525092915050565b5f80604083850312156105dc575f80fd5b82356105e781610395565b915060208301356105f781610435565b809150509250929050565b5f6040828403121561060f575f80fd5b6040516040810181811067ffffffffffffffff8211171561063f57634e487b7160e01b5f52604160045260245ffd5b604052825161064d81610435565b8152602083015161065d81610435565b60208201529392505050565b5f60408284031215610679575f80fd5b61040083836105fe565b63ffffffff818116838216019080821115610705577f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5092915050565b6bffffffffffffffffffffffff818116838216019080821115610705575f80fd5b5f60208284031215610735575f80fd5b5035919050565b5f815180845261075381602086016020860161047c565b601f01601f19169290920160200192915050565b6020808252825182820181905f918401906040840190835b818110156107b257835180516001600160a01b0316845260209081015181850152909301926040909201916001016107895b50929695505050505050565b5f80604083850312156107e3575f80fd5b82516107ee81610435565b60208401519092506105f781610435565b5f60208284031215610812575f80fd5b813561040081610395565b5f5b8381101561083757818101518382015260200161081f565b50505f910152565b602081525f610851602083018461073c565b9392505050565b5f8060408385031215610869575f80fd5b505080516020909101519092909150565b5f805f60608486031215610884575f80fd5b833592506020840135915060408401356001600160a01b038116811461048457565b5f8083601f8401126108b6575f80fd5b50813567ffffffffffffffff8111156108cd575f80fd5b6020830191508360208285010111156108e4575f80fd5b9250929050565b5f80602083850312156108fc575f80fd5b823567ffffffffffffffff81111561091257600080fd5b61091e858286016108a5565b90969095509350505050565b604081525f610851604083018561073c565b604081525f610851604083018561073c565b5f60208284031215610955575f80fd5b815161096081610435565b9392505050565b5f806040838503121561097857600080fd5b825161098381610435565b60208401519092506105f781610435565b5f60408284031215610672575f80fd5b6bffffffffffffffffffffffff828116828216039080821115610705575f80fd5b634e487b7160e01b5f52601160045260245ffd5b808202811582820484141761040057610400610983565b5f826109d357634e487b7160e01b5f52601260045260245ffd5b50049056fea264697066735822122076fed45f8f3ea9e6ce93f9b3e0f5e7f3e8e3a38c9b1c3af0c5fb0e1e4b8ee64736f6c63430008160033";

const IGP_ABI = [
  "constructor(address _owner, address _beneficiary)",
  "function owner() view returns (address)",
  "function beneficiary() view returns (address)",
  "function setDestinationGasConfig(uint32 remoteDomain, address gasOracle, uint96 gasOverhead)",
  "function quoteGasPayment(uint32 destinationDomain, uint256 gasAmount) view returns (uint256)",
  "function hookType() pure returns (uint8)",
  "function claim()"
];

async function main() {
  console.log("=".repeat(80));
  console.log("ğŸš€ DEPLOY IGP E ASSOCIAR AO WARP ROUTE - SEPOLIA");
  console.log("=".repeat(80));
  console.log("");

  // Conectar ao provider
  const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
  const wallet = new ethers.Wallet(PRIVATE_KEY, provider);

  console.log("ğŸ“‹ ConfiguraÃ§Ã£o:");
  console.log(`   Owner: ${OWNER_ADDRESS}`);
  console.log(`   Oracle: ${ORACLE_ADDRESS}`);
  console.log(`   Warp Route: ${WARP_ROUTE}`);
  console.log("");

  // Verificar saldo
  const balance = await provider.getBalance(OWNER_ADDRESS);
  console.log(`ğŸ’° Saldo: ${ethers.utils.formatEther(balance)} ETH`);
  console.log("");

  // Deploy IGP
  console.log("ğŸš€ Fazendo deploy do IGP...");
  
  const factory = new ethers.ContractFactory(IGP_ABI, IGP_BYTECODE, wallet);
  const igp = await factory.deploy(OWNER_ADDRESS, OWNER_ADDRESS, {
    gasLimit: 2000000
  });
  
  console.log(`   Aguardando confirmaÃ§Ã£o...`);
  await igp.deployed();
  
  console.log(`âœ… IGP deployado!`);
  console.log(`   EndereÃ§o: ${igp.address}`);
  console.log(`   TX: ${igp.deployTransaction.hash}`);
  console.log("");

  // Configurar IGP com Oracle
  console.log("âš™ï¸  Configurando IGP com Oracle...");
  
  const configTx = await igp.setDestinationGasConfig(
    TERRA_DOMAIN,
    ORACLE_ADDRESS,
    GAS_OVERHEAD,
    { gasLimit: 200000 }
  );
  
  await configTx.wait();
  
  console.log(`âœ… IGP configurado!`);
  console.log(`   TX: ${configTx.hash}`);
  console.log("");

  // Associar ao Warp Route
  console.log("ğŸ”— Associando IGP ao Warp Route...");
  
  const warpRoute = new ethers.Contract(
    WARP_ROUTE,
    ["function setHook(address _hook)", "function hook() view returns (address)"],
    wallet
  );
  
  const hookTx = await warpRoute.setHook(igp.address, { gasLimit: 200000 });
  await hookTx.wait();
  
  console.log(`âœ… IGP associado ao Warp Route!`);
  console.log(`   TX: ${hookTx.hash}`);
  console.log("");

  // VerificaÃ§Ã£o
  console.log("ğŸ” Verificando configuraÃ§Ã£o...");
  const currentHook = await warpRoute.hook();
  console.log(`   Hook atual do Warp Route: ${currentHook}`);
  console.log("");

  // Salvar configuraÃ§Ã£o
  const config = {
    network: "sepolia",
    deployedAt: new Date().toISOString(),
    contracts: {
      storageGasOracle: ORACLE_ADDRESS,
      interchainGasPaymaster: igp.address,
      warpRoute: WARP_ROUTE
    },
    configuration: {
      terraDomain: TERRA_DOMAIN,
      terraExchangeRate: TERRA_EXCHANGE_RATE,
      terraGasPrice: TERRA_GAS_PRICE,
      gasOverhead: GAS_OVERHEAD,
      owner: OWNER_ADDRESS
    },
    transactions: {
      oracleAddress: ORACLE_ADDRESS,
      igpDeploy: igp.deployTransaction.hash,
      igpConfig: configTx.hash,
      hookAssociation: hookTx.hash
    }
  };

  const fs = require('fs');
  fs.writeFileSync(
    '/home/lunc/cw-hyperlane/deployment-sepolia-igp-final.json',
    JSON.stringify(config, null, 2)
  );

  console.log("=".repeat(80));
  console.log("âœ… DEPLOY COMPLETO - SUCESSO!");
  console.log("=".repeat(80));
  console.log("");
  console.log("ğŸ“‹ Resumo:");
  console.log("â”€".repeat(80));
  console.log(`StorageGasOracle:         ${ORACLE_ADDRESS}`);
  console.log(`InterchainGasPaymaster:   ${igp.address}`);
  console.log(`Warp Route:               ${WARP_ROUTE}`);
  console.log("");
  console.log("ğŸ’¾ ConfiguraÃ§Ã£o salva em: deployment-sepolia-igp-final.json");
  console.log("=".repeat(80));
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error("\nâŒ Erro:", error.message);
    process.exit(1);
  });
