import { DirectSecp256k1Wallet } from "@cosmjs/proto-signing";
import { SigningCosmWasmClient } from "@cosmjs/cosmwasm-stargate";
import { SigningStargateClient, GasPrice } from "@cosmjs/stargate";
import { CosmWasmClient } from "@cosmjs/cosmwasm-stargate";

// ==============================
// CONFIGURATION - TESTNET
// ==============================
const WALLET_NAME = "hyperlane-testnet";
const CHAIN_ID = "rebel-2";
const NODE = "https://rpc.luncblaze.com:443";

// GET FROM ENVIRONMENT
const PRIVATE_KEY_HEX = process.env.PRIVATE_KEY || process.env.TERRA_PRIVATE_KEY || undefined;

// ---------------------------
// CONTRACT ADDRESSES (TESTNET)
// ---------------------------
const ISM_ROUTING = "terra1h4sd8fyxhde7dc9w9y9zhc2epphgs75q7zzfg3tfynm8qvpe3jlsd7sauh";
// ‚ö†Ô∏è IMPORTANTE: Substitua pelo endere√ßo do ISM Multisig Sepolia ap√≥s instanci√°-lo
const ISM_MULTISIG_SEPOLIA = process.env.ISM_MULTISIG_SEPOLIA || "terra1mzkakdts4958dyks72saw9wgas2eqmmxpuqc8gut2jvt9xuj8qzqc03vxa";

// Domain IDs
const DOMAIN_SEPOLIA = 11155111;

// ============================================================================
// FUNCTIONS
// ============================================================================

/**
 * Query all ISMs configured in ISM Routing contract
 */
async function queryAllISMs(client: CosmWasmClient): Promise<void> {
  console.log("\n" + "=".repeat(80));
  console.log("üìã QUERYING ALL ISMs CONFIGURED IN ISM ROUTING");
  console.log("=".repeat(80) + "\n");

  try {
    // Query ISM Routing contract for each known domain
    // Based on error message: expected one of `ownable`, `ism`, `routing_ism`
    console.log("Querying ISM Routing contract for known domains...");
    console.log("Contract:", ISM_ROUTING);
    console.log("");

    // Known testnet domains
    const knownDomains = [
      { domain: 97, name: "BSC Testnet" },
      { domain: 1399811150, name: "Solana Testnet" },
      { domain: 11155111, name: "Sepolia Testnet" },
      { domain: 1325, name: "Terra Classic" },
    ];

    const isms: any[] = [];

    for (const { domain, name } of knownDomains) {
      try {
        // Query format: routing_ism.route with message
        // We need to query with a message to get the ISM for a domain
        // But routing_ism.route expects a message, not a domain
        // Let's try ism query instead
        const queryMsg = {
          ism: {
            message: "0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
          },
        };
        const ismResult = await client.queryContractSmart(ISM_ROUTING, queryMsg);
        if (ismResult && ismResult.ism) {
          isms.push({ domain, name, ism: ismResult.ism });
        }
      } catch (err: any) {
        // Domain not configured or query failed
        // Continue to next domain
      }
    }

    const result = { isms };

    console.log("‚úÖ QUERY SUCCESSFUL!");
    console.log("‚îÄ".repeat(80));
    
    // Handle different response formats
    let isms: any[] = [];
    if (result && result.isms) {
      isms = Array.isArray(result.isms) ? result.isms : [];
    } else if (result && result.routes) {
      // If response has routes, extract ISMs from routes
      isms = Array.isArray(result.routes) ? result.routes : [];
    } else if (Array.isArray(result)) {
      isms = result;
    }
    
    if (isms.length > 0 || (result && Object.keys(result).length > 0)) {
      console.log(`\nüìä Total ISMs configured: ${isms.length}\n`);
      
      if (isms.length === 0) {
        console.log("‚ö†Ô∏è  No ISMs configured yet.");
      } else {
        console.log("üìã CONFIGURED ISMs:");
        console.log("‚îÄ".repeat(80));
        
        isms.forEach((ism: any, index: number) => {
          console.log(`\n[${index + 1}] Domain: ${ism.domain}`);
          console.log(`    ISM Address: ${ism.ism || ism.address}`);
          
          // Domain name mapping
          const domainNames: { [key: number]: string } = {
            97: "BSC Testnet",
            1399811150: "Solana Testnet",
            11155111: "Sepolia Testnet",
            1325: "Terra Classic",
          };
          
          const domainName = domainNames[ism.domain] || "Unknown";
          console.log(`    Chain: ${domainName}`);
        });
        
        // Check if Sepolia is already configured
        const sepoliaISM = isms.find((ism: any) => ism.domain === DOMAIN_SEPOLIA);
        if (sepoliaISM) {
          console.log("\n‚úÖ Sepolia ISM is already configured!");
          console.log(`   Domain: ${sepoliaISM.domain}`);
          console.log(`   ISM: ${sepoliaISM.ism || sepoliaISM.address}`);
        } else {
          console.log("\n‚ö†Ô∏è  Sepolia ISM is NOT configured yet.");
          console.log("   You need to add it using this script.");
        }
      }
    } else {
      console.log("‚ö†Ô∏è  Unexpected response format:");
      console.log(JSON.stringify(result, null, 2));
    }
    
    console.log("\n" + "=".repeat(80));
  } catch (error: any) {
    console.error("‚ùå ERROR QUERYING ISMs!");
    console.error("‚îÄ".repeat(80));
    console.error("Error:", error.message);
    
    // Try alternative query format
    console.log("\nüîÑ Trying alternative query format...");
    try {
      const altQuery = {
        router: {
          routes: {},
        },
      };
      const altResult = await client.queryContractSmart(ISM_ROUTING, altQuery);
      console.log("‚úÖ Alternative query successful!");
      console.log(JSON.stringify(altResult, null, 2));
    } catch (altError: any) {
      console.error("‚ùå Alternative query also failed:", altError.message);
      console.log("\nüí° Try querying manually with terrad:");
      console.log(`terrad query wasm contract-state smart ${ISM_ROUTING} '{"router":{"list_isms":{}}}' --node ${NODE}`);
    }
  }
}

/**
 * Execute the message to add Sepolia ISM to ISM Routing
 */
async function addSepoliaISM(
  client: SigningCosmWasmClient,
  sender: string
): Promise<void> {
  console.log("\n" + "=".repeat(80));
  console.log("üöÄ ADDING SEPOLIA ISM TO ISM ROUTING");
  console.log("=".repeat(80) + "\n");

  const execMsg = {
    router: {
      set_ism: {
        set: {
          domain: DOMAIN_SEPOLIA,              // Sepolia Testnet
          ism: ISM_MULTISIG_SEPOLIA,           // ISM Multisig Sepolia address
        },
      },
    },
  };

  console.log("üìã EXECUTION MESSAGE:");
  console.log("‚îÄ".repeat(80));
  console.log("Contract:", ISM_ROUTING);
  console.log("Domain:", DOMAIN_SEPOLIA, "(Sepolia Testnet)");
  console.log("ISM Multisig:", ISM_MULTISIG_SEPOLIA);
  console.log("\nMessage:", JSON.stringify(execMsg, null, 2));
  console.log("");

  // Check if ISM_MULTISIG_SEPOLIA is set correctly
  if (ISM_MULTISIG_SEPOLIA.includes("REPLACE") || !ISM_MULTISIG_SEPOLIA.startsWith("terra")) {
    console.error("‚ö†Ô∏è  ERROR: ISM_MULTISIG_SEPOLIA not set correctly!");
    console.error("=".repeat(80));
    console.error("\nYou must set the ISM Multisig Sepolia address.");
    console.error("Set environment variable:");
    console.error("  export ISM_MULTISIG_SEPOLIA='terra1...'");
    console.error("\nOr edit this script and replace ISM_MULTISIG_SEPOLIA constant.");
    console.error("=".repeat(80) + "\n");
    process.exit(1);
  }

  console.log("Executing transaction...");
  console.log("");

  try {
    const result = await client.execute(
      sender,
      ISM_ROUTING,
      execMsg,
      "auto",
      undefined,
      []
    );

    console.log("‚úÖ SUCCESS!");
    console.log("‚îÄ".repeat(80));
    console.log("  ‚Ä¢ TX Hash:", result.transactionHash);
    console.log("  ‚Ä¢ Gas used:", result.gasUsed);
    console.log("  ‚Ä¢ Height:", result.height);
    console.log("\nüí° Next steps:");
    console.log("  1. Wait for transaction confirmation");
    console.log("  2. Query ISMs again to verify Sepolia was added");
    console.log("  3. Test cross-chain message sending from Sepolia");
    console.log("=".repeat(80) + "\n");
  } catch (error: any) {
    console.error("‚ùå ERROR!");
    console.error("‚îÄ".repeat(80));
    console.error("  ‚Ä¢ Message:", error.message);
    if (error.log) {
      console.error("  ‚Ä¢ Log:", error.log);
    }
    throw error;
  }
}

/**
 * Main function
 */
async function main() {
  if (!PRIVATE_KEY_HEX) {
    console.error("ERROR: Set the PRIVATE_KEY environment variable.");
    console.error('Example: PRIVATE_KEY="abcdef..." npx tsx script/add-ism-sepolia-sepolia.ts');
    console.error("\nOr use TERRA_PRIVATE_KEY:");
    console.error('TERRA_PRIVATE_KEY="abcdef..." npx tsx script/add-ism-sepolia-sepolia.ts');
    return;
  }

  // Create wallet
  const privateKeyBytes = Uint8Array.from(Buffer.from(PRIVATE_KEY_HEX, "hex"));
  const wallet = await DirectSecp256k1Wallet.fromKey(privateKeyBytes, "terra");
  const [account] = await wallet.getAccounts();
  const sender = account.address;

  console.log("=".repeat(80));
  console.log("üîß ADD SEPOLIA ISM TO ISM ROUTING");
  console.log("=".repeat(80));
  console.log("\nConfiguration:");
  console.log("  Wallet:", sender);
  console.log("  Chain ID:", CHAIN_ID);
  console.log("  Node:", NODE);
  console.log("  ISM Routing:", ISM_ROUTING);
  console.log("  ISM Multisig Sepolia:", ISM_MULTISIG_SEPOLIA);
  console.log("  Domain Sepolia:", DOMAIN_SEPOLIA);

  // Connect clients
  const signingClient = await SigningCosmWasmClient.connectWithSigner(NODE, wallet, {
    gasPrice: GasPrice.fromString("28.5uluna"),
  });

  const queryClient = await CosmWasmClient.connect(NODE);

  console.log("\n‚úì Connected to node\n");

  // Check execution mode
  const mode = process.env.MODE || "query";

  if (mode === "execute" || mode === "add") {
    // First query to show current state
    await queryAllISMs(queryClient);
    
    // Then execute
    await addSepoliaISM(signingClient, sender);
    
    // Wait a bit for transaction to be included
    console.log("\n‚è≥ Waiting 5 seconds for transaction to be included...");
    await new Promise(resolve => setTimeout(resolve, 5000));
    
    // Query again to verify
    console.log("\nüîç Verifying ISM was added...");
    await queryAllISMs(queryClient);
  } else {
    // Query only mode (default)
    await queryAllISMs(queryClient);
    
    console.log("\nüí° To add Sepolia ISM, run with MODE=execute:");
    console.log("   MODE=execute npx tsx script/add-ism-sepolia-sepolia.ts");
    console.log("\nOr set MODE=add:");
    console.log("   MODE=add npx tsx script/add-ism-sepolia-sepolia.ts");
  }
}

main().catch((error) => {
  console.error("\nError executing:", error);
  process.exit(1);
});
